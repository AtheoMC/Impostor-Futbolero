<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Futbolero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Establecer el nivel de registro para depuración
        setLogLevel('debug');

        // Variables globales del entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Configuración de Firebase - Utiliza la configuración proporcionada por el usuario
        const firebaseConfig = {
            apiKey: "AIzaSyCumowABsEKfX_js3s0KjdIGi0Oor6MXvA",
            authDomain: "impostor-futbolero-online.firebaseapp.com",
            projectId: "impostor-futbolero-online",
            storageBucket: "impostor-futbolero-online.firebasestorage.app",
            messagingSenderId: "1067586840575",
            appId: "1:1067586840575:web:32889c085f7cf461bfa9ca",
            measurementId: "G-W7NY2T2V2C"
        };
        
        // --- Configuración e inicialización de Firebase ---
        let db;
        let auth;
        let userId = null;
        let userName = null;
        let roomDocRef = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase inicializado con éxito.");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        const roomsCollectionName = 'rooms';

        // --- Elementos de la UI ---
        const loadingScreen = document.getElementById('loadingScreen');
        const homeScreen = document.getElementById('homeScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const votingScreen = document.getElementById('votingScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const userNameInput = document.getElementById('userNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomInput = document.getElementById('joinRoomInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const lobbyPlayersList = document.getElementById('lobbyPlayersList');
        const startGameBtn = document.getElementById('startGameBtn');
        const roleCard = document.getElementById('roleCard');
        const votingPlayersList = document.getElementById('votingPlayersList');
        const voteTimerDisplay = document.getElementById('voteTimerDisplay');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const finalPlayersList = document.getElementById('finalPlayersList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');

        let currentRoomId = null;
        let userRole = null;
        let hasVoted = false;
        let timerIntervalId = null;

        // Función para mostrar una pantalla
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Función para mostrar mensajes temporales en la UI
        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            setTimeout(() => {
                messageModal.classList.add('hidden');
            }, 3000); // El mensaje desaparece después de 3 segundos
        }

        // --- Lógica de Autenticación y Carga ---
        let authHandled = false;

        onAuthStateChanged(auth, async (user) => {
            if (authHandled) return;
            authHandled = true;

            if (user) {
                userId = user.uid;
                console.log("Usuario autenticado:", userId);
                userIdDisplay.textContent = `ID de Usuario: ${userId}`;
                userName = localStorage.getItem('userName');
                if (userName) {
                    userNameInput.value = userName;
                }
                showMessage("Conexión a la base de datos exitosa.");
                showScreen('homeScreen');
            } else {
                console.log("Usuario no autenticado, iniciando sesión anónima...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error en la autenticación:", error);
                    showMessage("Error al iniciar sesión. Intenta recargar la página.");
                    showScreen('homeScreen');
                }
            }
        });
        
        // Fallback si la autenticación es demasiado lenta
        setTimeout(() => {
            if (!authHandled) {
                console.log("Autenticación lenta, pasando a la pantalla de inicio como fallback.");
                showScreen('homeScreen');
            }
        }, 5000);

        // --- Lógica del Juego ---
        createRoomBtn.addEventListener('click', async () => {
            userName = userNameInput.value.trim();
            if (!userName) {
                showMessage("Por favor, ingresa un nombre de usuario.");
                return;
            }
            localStorage.setItem('userName', userName);

            try {
                const roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
                roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', roomsCollectionName, roomCode);
                
                await setDoc(roomDocRef, {
                    host: { userId: userId, name: userName },
                    players: [{ userId: userId, name: userName, isEliminated: false }],
                    status: 'lobby',
                    votes: {},
                    createdAt: new Date()
                });

                currentRoomId = roomCode;
                console.log("Sala creada con ID:", currentRoomId);
                subscribeToRoomUpdates(currentRoomId);
                showScreen('lobbyScreen');
            } catch (error) {
                console.error("Error al crear la sala:", error);
                showMessage("No se pudo crear la sala. Inténtalo de nuevo.");
            }
        });

        joinRoomBtn.addEventListener('click', async () => {
            userName = userNameInput.value.trim();
            if (!userName) {
                showMessage("Por favor, ingresa un nombre de usuario.");
                return;
            }
            localStorage.setItem('userName', userName);

            const roomCode = joinRoomInput.value.trim().toUpperCase();
            if (!roomCode) {
                showMessage("Por favor, ingresa un código de sala.");
                return;
            }

            roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', roomsCollectionName, roomCode);

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDocForTxn = await transaction.get(roomDocRef);
                    if (!roomDocForTxn.exists()) {
                        throw "La sala no existe.";
                    }
                    const roomData = roomDocForTxn.data();

                    if (roomData.status !== 'lobby') {
                        throw "La sala ya ha empezado el juego.";
                    }
                    
                    const players = roomData.players;
                    if (!players.find(p => p.userId === userId)) {
                        const updatedPlayers = [...players, { userId: userId, name: userName, isEliminated: false }];
                        transaction.update(roomDocRef, { players: updatedPlayers });
                    }
                    currentRoomId = roomCode;
                    console.log("Unido a la sala:", currentRoomId);
                });
                subscribeToRoomUpdates(currentRoomId);
                showScreen('lobbyScreen');
            } catch (error) {
                console.error("Error al unirse a la sala:", error);
                showMessage("No se pudo unir a la sala. Verifica el código e inténtalo de nuevo.");
            }
        });

        // Suscribirse a las actualizaciones de la sala en tiempo real
        function subscribeToRoomUpdates(roomCode) {
            roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', roomsCollectionName, roomCode);
            onSnapshot(roomDocRef, (doc) => {
                if (doc.exists()) {
                    const roomData = doc.data();
                    if (roomData.status === 'lobby') {
                        updateLobbyUI(roomData);
                    } else if (roomData.status === 'in_game') {
                        assignAndShowRole(roomData);
                    } else if (roomData.status === 'voting') {
                        showVotingScreen(roomData);
                    } else if (roomData.status === 'game_over') {
                        showGameOver(roomData);
                    }
                } else {
                    showMessage("La sala ha sido eliminada.");
                    showScreen('homeScreen');
                }
            }, (error) => {
                console.error("Error al escuchar la sala:", error);
                showMessage("Se perdió la conexión. Inténtalo de nuevo.");
                showScreen('homeScreen');
            });
        }
        
        // Actualizar la UI del lobby
        function updateLobbyUI(roomData) {
            roomCodeDisplay.textContent = currentRoomId;
            lobbyPlayersList.innerHTML = '';
            roomData.players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                li.classList.add('p-2', 'bg-gray-700', 'rounded-lg', 'text-lg', 'text-white', 'text-center');
                if (player.userId === roomData.host.userId) {
                    li.textContent += ' (Anfitrión)';
                    li.classList.add('bg-yellow-600', 'font-bold');
                }
                lobbyPlayersList.appendChild(li);
            });

            if (roomData.host.userId === userId && roomData.players.length >= 2) {
                startGameBtn.classList.remove('hidden');
            } else {
                startGameBtn.classList.add('hidden');
            }
            showScreen('lobbyScreen');
        }
        
        startGameBtn.addEventListener('click', async () => {
             await runTransaction(db, async (transaction) => {
                const roomDocForTxn = await transaction.get(roomDocRef);
                if (!roomDocForTxn.exists()) {
                    throw "Document does not exist!";
                }
                const roomData = roomDocForTxn.data();

                if (roomData.players.length < 2) {
                    showMessage("Necesitas al menos 2 jugadores para empezar el juego.");
                    return;
                }
                
                // Asignar roles aleatoriamente
                const players = [...roomData.players];
                const impostorIndex = Math.floor(Math.random() * players.length);
                const updatedPlayers = players.map((player, index) => {
                    return { ...player, role: index === impostorIndex ? 'Impostor' : 'Futbolero', isEliminated: false };
                });

                transaction.update(roomDocRef, {
                    players: updatedPlayers,
                    status: 'in_game',
                    votes: {},
                    gameStartedAt: new Date()
                });
            });
        });

        // Asignar y mostrar el rol al usuario actual
        function assignAndShowRole(roomData) {
            const player = roomData.players.find(p => p.userId === userId);
            if (player) {
                userRole = player.role;
                roleCard.innerHTML = `
                    <h3 class="text-4xl font-bold mb-2">Tu rol es:</h3>
                    <p class="text-6xl font-extrabold mb-4 ${userRole === 'Impostor' ? 'text-red-500' : 'text-green-500'}">
                        ${userRole}
                    </p>
                    <p class="text-xl text-gray-400">
                        ${userRole === 'Impostor' ? 'Tu objetivo es sabotear el partido. Evita que el juego termine correctamente.' : 'Tu objetivo es jugar y marcar un gol. ¡Atrapa al impostor!'}
                    </p>
                `;
                showScreen('gameScreen');

                // Mostrar la lista de jugadores en la pantalla de juego
                const gamePlayersList = document.getElementById('gamePlayersList');
                gamePlayersList.innerHTML = '';
                roomData.players.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = p.name;
                    li.classList.add('p-2', 'bg-gray-700', 'rounded-lg', 'text-lg', 'text-white', 'text-center');
                    gamePlayersList.appendChild(li);
                });
            } else {
                showMessage("No se pudo encontrar tu rol en esta sala.");
                showScreen('homeScreen');
            }
        }
        
        // Evento para llamar a la votación
        const callVoteBtn = document.getElementById('callVoteBtn');
        if (callVoteBtn) {
            callVoteBtn.addEventListener('click', async () => {
                await setDoc(roomDocRef, { status: 'voting' }, { merge: true });
            });
        }

        // Lógica de votación
        function showVotingScreen(roomData) {
            showScreen('votingScreen');
            votingPlayersList.innerHTML = '';
            hasVoted = roomData.votes[userId] !== undefined;

            roomData.players.forEach(player => {
                // Solo muestra jugadores que no están eliminados
                if (!player.isEliminated) {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'bg-gray-700', 'rounded-lg', 'text-lg');
                    li.innerHTML = `
                        <span class="text-white">${player.name}</span>
                        <button class="vote-btn btn btn-primary p-2 rounded-lg font-semibold text-sm ${hasVoted ? 'bg-gray-500 cursor-not-allowed' : ''}" data-player-id="${player.userId}" ${hasVoted ? 'disabled' : ''}>Votar</button>
                    `;
                    votingPlayersList.appendChild(li);
                }
            });

            setTimeout(() => {
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if (hasVoted) return;
                        
                        const votedPlayerId = e.target.getAttribute('data-player-id');
                        await vote(votedPlayerId);
                        
                        document.querySelectorAll('.vote-btn').forEach(b => {
                            b.disabled = true;
                            b.classList.add('bg-gray-500', 'cursor-not-allowed');
                        });
                        showMessage("Tu voto ha sido registrado.");
                    });
                });
            }, 100);

            // Temporizador para la votación
            let timer = 10;
            voteTimerDisplay.textContent = timer;
            if (timerIntervalId) {
                clearInterval(timerIntervalId);
            }
            timerIntervalId = setInterval(() => {
                timer--;
                voteTimerDisplay.textContent = timer;
                if (timer <= 0) {
                    clearInterval(timerIntervalId);
                    processVotes(roomData.players);
                }
            }, 1000);
        }
        
        async function vote(votedPlayerId) {
            await runTransaction(db, async (transaction) => {
                const roomDocForTxn = await transaction.get(roomDocRef);
                const roomData = roomDocForTxn.data();
                const votes = roomData.votes || {};
                
                votes[userId] = votedPlayerId;
                
                transaction.update(roomDocRef, { votes: votes });
            });
        }
        
        async function processVotes(players) {
            const roomDoc = await getDoc(roomDocRef);
            const roomData = roomDoc.data();
            const votes = roomData.votes || {};

            const voteCounts = {};
            for (const voterId in votes) {
                const votedPlayerId = votes[voterId];
                voteCounts[votedPlayerId] = (voteCounts[votedPlayerId] || 0) + 1;
            }

            let mostVotedPlayerId = null;
            let maxVotes = 0;
            for (const playerId in voteCounts) {
                if (voteCounts[playerId] > maxVotes) {
                    maxVotes = voteCounts[playerId];
                    mostVotedPlayerId = playerId;
                }
            }
            
            let winner = 'Futboleros';
            if (mostVotedPlayerId) {
                const eliminatedPlayer = players.find(p => p.userId === mostVotedPlayerId);
                if (eliminatedPlayer && eliminatedPlayer.role === 'Impostor') {
                    winner = 'Futboleros';
                } else {
                    winner = 'Impostor';
                }
            } else {
                 winner = 'Futboleros';
            }

            if (mostVotedPlayerId) {
                await runTransaction(db, async (transaction) => {
                    const roomDocForTxn = await transaction.get(roomDocRef);
                    const roomData = roomDocForTxn.data();
                    const players = roomData.players;
                    const updatedPlayers = players.map(p => {
                        if (p.userId === mostVotedPlayerId) {
                            return { ...p, isEliminated: true };
                        }
                        return p;
                    });
                    transaction.update(roomDocRef, { players: updatedPlayers });
                });
            }

            await setDoc(roomDocRef, { status: 'game_over', winner: winner }, { merge: true });
        }
        
        // Mostrar la pantalla de fin de juego
        function showGameOver(roomData) {
            if (roomData.winner === 'Impostor') {
                gameOverMessage.textContent = '¡El Impostor ha ganado!';
                gameOverMessage.classList.add('text-red-500');
            } else {
                gameOverMessage.textContent = '¡Los Futboleros han ganado!';
                gameOverMessage.classList.add('text-green-500');
            }
            
            finalPlayersList.innerHTML = '';
            roomData.players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name} - ${p.role}`;
                li.classList.add('p-2', 'bg-gray-700', 'rounded-lg', 'text-lg', 'text-white', 'text-center');
                if (p.isEliminated) {
                    li.classList.add('line-through', 'text-gray-400');
                }
                finalPlayersList.appendChild(li);
            });
            showScreen('gameOverScreen');
            
            // Reiniciar la partida automáticamente después de 10 segundos
            setTimeout(async () => {
                await setDoc(roomDocRef, {
                    players: roomData.players.map(p => ({ userId: p.userId, name: p.name, isEliminated: false })),
                    status: 'lobby',
                    votes: {}
                });
            }, 10000);
        }
        
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 90%;
            margin: auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #1E1E1E;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .input-field {
            background-color: #2E2E2E;
            border: 1px solid #444;
            color: #E0E0E0;
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .btn {
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background-color: #007BFF;
            color: #fff;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .role-card {
            background: linear-gradient(135deg, #1f2937, #374151);
            padding: 2rem;
            border-radius: 1.5rem;
            border: 2px solid;
            border-image: linear-gradient(45deg, #FFD700, #FFA500) 1;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            text-align: center;
        }
        #userIdDisplay {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: #888;
        }
        #messageModal {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #121212;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 99;
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center font-sans">
    
    <div id="loadingScreen" class="screen h-screen flex items-center justify-center">
        <h1 class="text-3xl font-bold animate-pulse">Cargando...</h1>
    </div>

    <div id="homeScreen" class="screen hidden h-screen flex items-center justify-center">
        <div class="container card text-center p-8">
            <h2 class="text-3xl font-bold mb-4">Impostor Futbolero</h2>
            <p class="mb-6 text-lg text-gray-400">¿Cómo te llamas?</p>
            <input type="text" id="userNameInput" placeholder="Ingresa tu nombre..." class="input-field w-full mb-4">
            <div class="space-y-4">
                <button id="createRoomBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl">Crear Sala</button>
                <div class="flex items-center space-x-2">
                    <input type="text" id="joinRoomInput" placeholder="Código de sala..." class="input-field flex-grow p-4 rounded-lg text-lg text-center">
                    <button id="joinRoomBtn" class="btn btn-primary p-4 rounded-lg font-semibold text-lg">Unirse</button>
                </div>
            </div>
            <p class="text-sm mt-4 text-gray-500">
                Crea una sala para que tus amigos se unan o únete a una existente.
            </p>
        </div>
    </div>

    <div id="lobbyScreen" class="screen hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center p-8">
            <h2 class="text-3xl font-bold mb-4">Sala de Juego</h2>
            <p class="text-xl mb-4">Código: <span id="roomCodeDisplay" class="font-bold text-yellow-400"></span></p>
            <p class="text-lg mb-2">Jugadores:</p>
            <ul id="lobbyPlayersList" class="mb-6 space-y-2"></ul>
            <button id="startGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl hidden">Empezar Juego</button>
            <p class="text-sm mt-4 text-gray-500">Comparte el código con tus amigos para que se unan.</p>
        </div>
    </div>

    <div id="gameScreen" class="screen hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center p-8">
            <div id="roleCard" class="role-card"></div>
            <div class="mt-8 w-full">
                <h3 class="text-2xl font-bold mb-4">Jugadores en la partida</h3>
                <ul id="gamePlayersList" class="mb-6 space-y-2"></ul>
            </div>
            <button id="callVoteBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl mt-4">Llamar a votación</button>
        </div>
    </div>

    <div id="votingScreen" class="screen hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center p-8">
            <h2 class="text-3xl font-bold mb-4">¡A Votar!</h2>
            <p class="text-lg mb-2">Tiempo restante: <span id="voteTimerDisplay" class="font-bold">10</span>s</p>
            <ul id="votingPlayersList" class="mb-6 space-y-2"></ul>
        </div>
    </div>

    <div id="gameOverScreen" class="screen hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center p-8">
            <h2 id="gameOverMessage" class="text-4xl font-extrabold mb-4"></h2>
            <div class="mt-8 w-full">
                <h3 class="text-2xl font-bold mb-4">Roles Finales</h3>
                <ul id="finalPlayersList" class="mb-6 space-y-2"></ul>
            </div>
        </div>
    </div>

    <!-- Mensaje temporal sin modal -->
    <div id="messageModal" class="hidden">
        <p id="messageText"></p>
    </div>

    <div id="userIdDisplay"></div>
</body>
</html>
