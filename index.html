<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Futbolero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 90%;
            margin: auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #1E1E1E;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .input-field {
            background-color: #2E2E2E;
            border: 1px solid #444;
            color: #E0E0E0;
        }
        .btn {
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1769aa;
        }
        .btn-secondary {
            background-color: #4CAF50;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #388e3c;
        }
        .player-list-item {
            background-color: #2e2e2e;
        }
        .impostor-text {
            color: #f44336;
        }
        .crewmate-text {
            color: #4CAF50;
        }
        .eliminated-player {
            opacity: 0.5;
            text-decoration: line-through;
        }
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration
        let app, db, auth;
        let userId = null;
        let gameId = null;
        let isHost = false;
        let gameState = { state: 'loading' };
        let unsubscribeGame = null;

        // Player data and game-related data
        // Extended list of football players with placeholder images
        const footballPlayers = [
            { name: "Lionel Messi", image: "https://placehold.co/400x400/2196F3/ffffff?text=Messi" },
            { name: "Cristiano Ronaldo", image: "https://placehold.co/400x400/2196F3/ffffff?text=Ronaldo" },
            { name: "Kylian Mbappé", image: "https://placehold.co/400x400/2196F3/ffffff?text=Mbappe" },
            { name: "Neymar Jr.", image: "https://placehold.co/400x400/2196F3/ffffff?text=Neymar" },
            { name: "Erling Haaland", image: "https://placehold.co/400x400/2196F3/ffffff?text=Haaland" },
            { name: "Ronaldinho", image: "https://placehold.co/400x400/2196F3/ffffff?text=Ronaldinho" },
            { name: "Zinedine Zidane", image: "https://placehold.co/400x400/2196F3/ffffff?text=Zidane" },
            { name: "Pelé", image: "https://placehold.co/400x400/2196F3/ffffff?text=Pele" },
            { name: "Diego Maradona", image: "https://placehold.co/400x400/2196F3/ffffff?text=Maradona" },
            { name: "Mohamed Salah", image: "https://placehold.co/400x400/2196F3/ffffff?text=Salah" },
            { name: "Robert Lewandowski", image: "https://placehold.co/400x400/2196F3/ffffff?text=Lewandowski" },
            { name: "Kevin De Bruyne", image: "https://placehold.co/400x400/2196F3/ffffff?text=De+Bruyne" },
            { name: "Karim Benzema", image: "https://placehold.co/400x400/2196F3/ffffff?text=Benzema" },
            { name: "Luka Modrić", image: "https://placehold.co/400x400/2196F3/ffffff?text=Modric" },
            { name: "Andrés Iniesta", image: "https://placehold.co/400x400/2196F3/ffffff?text=Iniesta" },
            { name: "Johan Cruyff", image: "https://placehold.co/400x400/2196F3/ffffff?text=Cruyff" },
            { name: "Franz Beckenbauer", image: "https://placehold.co/400x400/2196F3/ffffff?text=Beckenbauer" },
            { name: "Kaká", image: "https://placehold.co/400x400/2196F3/ffffff?text=Kaka" },
            { name: "David Beckham", image: "https://placehold.co/400x400/2196F3/ffffff?text=Beckham" },
            { name: "Manuel Neuer", image: "https://placehold.co/400x400/2196F3/ffffff?text=Neuer" },
            { name: "Virgil van Dijk", image: "https://placehold.co/400x400/2196F3/ffffff?text=Van+Dijk" },
            { name: "Sergio Ramos", image: "https://placehold.co/400x400/2196F3/ffffff?text=Ramos" },
            { name: "Gabriel Batistuta", image: "https://placehold.co/400x400/2196F3/ffffff?text=Batistuta" },
            { name: "Thierry Henry", image: "https://placehold.co/400x400/2196F3/ffffff?text=Henry" },
            { name: "Romário", image: "https://placehold.co/400x400/2196F3/ffffff?text=Romario" }
        ];

        // UI elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const playerNameInput = document.getElementById('playerNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomInput = document.getElementById('joinRoomInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const lobbyPlayersList = document.getElementById('lobbyPlayersList');
        const gamePlayersList = document.getElementById('gamePlayersList');
        const startGameBtn = document.getElementById('startGameBtn');
        const roleCard = document.getElementById('roleCard');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const newGameBtn = document.getElementById('newGameBtn');

        // Custom modal to replace alert()
        function showModal(message) {
            const modal = document.createElement('div');
            modal.className = 'game-over-modal';
            modal.innerHTML = `
                <div class="card bg-gray-800 text-white p-6 rounded-2xl text-center">
                    <p class="text-xl font-semibold mb-4">${message}</p>
                    <button id="modalCloseBtn" class="btn btn-primary px-4 py-2">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modalCloseBtn').onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // Initialize Firebase services
        function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with the provided custom token or anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        showScreen(loginScreen);
                    } else {
                        try {
                             if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication error:", error);
                        }
                    }
                });
                console.log("Firebase initialized.");
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        // Functions to show/hide screens
        function showScreen(screen) {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        // Create a new game room
        async function createRoom() {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showModal("Por favor, introduce tu nombre.");
                return;
            }

            // Generate a simple, unique room code
            gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            const playerInfo = {
                name: playerName,
                status: 'active',
                isHost: true,
                role: null
            };
            const gameData = {
                state: 'lobby',
                hostId: userId,
                players: { [userId]: playerInfo },
                chosenPlayer: null,
                chosenPlayerImage: null,
                impostorId: null
            };

            try {
                await setDoc(gameDocRef, gameData);
                isHost = true;
                listenToGameChanges();
            } catch (e) {
                console.error("Error creating document: ", e);
            }
        }

        // Join an existing game room
        async function joinRoom() {
            gameId = joinRoomInput.value.trim().toUpperCase();
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                showModal("Por favor, introduce tu nombre.");
                return;
            }
            if (!gameId) {
                showModal("Por favor, introduce un código de sala.");
                return;
            }

            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            const gameDoc = await getDoc(gameDocRef);

            if (!gameDoc.exists() || gameDoc.data().state !== 'lobby') {
                showModal("Código de sala inválido o la partida ya ha comenzado.");
                return;
            }

            const updates = {};
            updates[`players.${userId}`] = { name: playerName, status: 'active', isHost: false, role: null };
            await updateDoc(gameDocRef, updates);
            isHost = false;
            listenToGameChanges();
        }

        // Listen for real-time changes to the game document
        function listenToGameChanges() {
            if (unsubscribeGame) {
                unsubscribeGame();
            }
            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            unsubscribeGame = onSnapshot(gameDocRef, (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    updateUI();
                } else {
                    console.log("Game room does not exist. Returning to home.");
                    showModal("La sala del juego no existe. Volviendo a la pantalla principal.");
                    setTimeout(() => location.reload(), 3000);
                }
            }, (error) => {
                console.error("Error listening to game state:", error);
                showModal("Hubo un error al sincronizar con la partida. Por favor, intenta de nuevo.");
            });
        }

        // Update the UI based on the game state
        function updateUI() {
            if (gameState.state === 'lobby') {
                showScreen(lobbyScreen);
                roomCodeDisplay.textContent = gameId;
                renderPlayers(lobbyPlayersList, gameState.players, false);
                const playerCount = Object.keys(gameState.players).length;
                if (isHost) {
                    startGameBtn.classList.remove('hidden');
                    startGameBtn.disabled = playerCount < 3;
                    startGameBtn.textContent = `Empezar Juego (${playerCount}/3+)`;
                } else {
                    startGameBtn.classList.add('hidden');
                }
            } else if (gameState.state === 'in-game') {
                showScreen(gameScreen);
                renderGameUI();
            } else if (gameState.state === 'game-over') {
                showScreen(gameOverScreen);
                const winnerText = gameState.impostorId ? (gameState.players[gameState.impostorId].status === 'eliminated' ? '¡La tripulación gana!' : '¡El impostor gana!') : 'El juego ha terminado.';
                gameOverMessage.textContent = winnerText;
                
                // Only host can start a new game
                if (isHost) {
                  newGameBtn.classList.remove('hidden');
                } else {
                  newGameBtn.classList.add('hidden');
                }
            }
        }

        // Render the list of players for the lobby/game
        function renderPlayers(listElement, playersData, isGameScreen) {
            listElement.innerHTML = '';
            for (const playerId in playersData) {
                const player = playersData[playerId];
                const li = document.createElement('li');
                li.className = `player-list-item flex justify-between items-center p-3 rounded-xl mb-2`;
                li.textContent = `${player.name}${player.isHost ? ' (Anfitrión)' : ''}`;
                
                if (player.status === 'eliminated') {
                    li.classList.add('eliminated-player');
                }

                if (isGameScreen && isHost && player.status === 'active' && playerId !== userId) {
                    const eliminateBtn = document.createElement('button');
                    eliminateBtn.textContent = 'Eliminar';
                    eliminateBtn.className = 'btn bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded-lg';
                    eliminateBtn.onclick = () => eliminatePlayer(playerId);
                    li.appendChild(eliminateBtn);
                }
                listElement.appendChild(li);
            }
        }

        // Start the game by assigning roles and updating Firestore
        async function startGame() {
            if (!isHost || Object.keys(gameState.players).length < 3) return;

            const playerIds = Object.keys(gameState.players);
            const impostorId = playerIds[Math.floor(Math.random() * playerIds.length)];
            const chosenPlayer = footballPlayers[Math.floor(Math.random() * footballPlayers.length)];

            const updates = {
                state: 'in-game',
                impostorId: impostorId,
                chosenPlayer: chosenPlayer.name,
                chosenPlayerImage: chosenPlayer.image
            };
            
            // Assign roles to each player locally first
            const updatedPlayers = {};
            for (const playerId of playerIds) {
                updatedPlayers[playerId] = {
                    ...gameState.players[playerId],
                    role: (playerId === impostorId) ? 'impostor' : 'crewmate'
                };
            }
            updates.players = updatedPlayers;
            
            try {
                await updateDoc(doc(db, `artifacts/${__app_id}/public/data/games`, gameId), updates);
            } catch (e) {
                console.error("Error starting game: ", e);
                showModal("Error al iniciar el juego. Inténtalo de nuevo.");
            }
        }

        // Render the game screen UI based on the player's role
        function renderGameUI() {
            const myPlayer = gameState.players[userId];
            const roleContainer = document.getElementById('roleCard');
            roleContainer.innerHTML = '';

            const h2 = document.createElement('h2');
            h2.className = 'text-3xl font-bold mb-4';

            if (myPlayer.role === 'impostor') {
                h2.textContent = 'Eres el IMPOSTOR';
                h2.className += ' impostor-text';

                const impostorText = document.createElement('p');
                impostorText.className = 'text-center text-lg';
                impostorText.textContent = `Tu objetivo es no ser descubierto. El jugador es ${gameState.chosenPlayer}.`;
                
                roleContainer.appendChild(h2);
                roleContainer.appendChild(impostorText);

            } else {
                h2.textContent = 'Eres de la tripulación';
                h2.className += ' crewmate-text';

                const playerImage = document.createElement('img');
                playerImage.src = gameState.chosenPlayerImage;
                playerImage.alt = gameState.chosenPlayer;
                playerImage.className = 'w-full max-w-sm rounded-xl mx-auto mb-4';

                const playerName = document.createElement('p');
                playerName.className = 'text-center text-2xl font-semibold';
                playerName.textContent = gameState.chosenPlayer;

                roleContainer.appendChild(h2);
                roleContainer.appendChild(playerImage);
                roleContainer.appendChild(playerName);
            }
            
            // Show player list in game screen with elimination button for host
            renderPlayers(gamePlayersList, gameState.players, true);
        }

        // Function to handle player elimination
        async function eliminatePlayer(playerIdToEliminate) {
            if (!isHost) return;
            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            const updates = {};
            updates[`players.${playerIdToEliminate}.status`] = 'eliminated';
            
            await updateDoc(gameDocRef, updates);
            checkGameEnd();
        }

        // Check if the game has ended
        function checkGameEnd() {
            const livingPlayers = Object.keys(gameState.players).filter(id => gameState.players[id].status === 'active');
            const impostorIsEliminated = gameState.players[gameState.impostorId].status === 'eliminated';
            
            if (impostorIsEliminated) {
                endGame();
            } else if (livingPlayers.length <= 2) {
                endGame();
            }
        }
        
        // End the game and show the game over screen
        async function endGame() {
            if (!isHost) return;
            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            await updateDoc(gameDocRef, { state: 'game-over' });
        }
        
        // Start a new game
        async function startNewGame() {
            if (!isHost) return;
            
            // Delete the old game document to start fresh
            const gameDocRef = doc(db, `artifacts/${__app_id}/public/data/games`, gameId);
            try {
                await setDoc(gameDocRef, {
                    state: 'lobby',
                    hostId: userId,
                    players: { [userId]: {
                        name: gameState.players[userId].name,
                        status: 'active',
                        isHost: true,
                        role: null
                    }},
                    chosenPlayer: null,
                    chosenPlayerImage: null,
                    impostorId: null
                });
                isHost = true;
                // The onSnapshot listener will handle the UI change
            } catch (e) {
                console.error("Error creating new game: ", e);
                showModal("Error al crear una nueva partida.");
            }
        }


        // Event listeners
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        startGameBtn.addEventListener('click', startGame);
        newGameBtn.addEventListener('click', startNewGame);

    </script>

    <!-- UI - Screens -->
    <div id="loadingScreen" class="h-screen flex items-center justify-center">
        <h1 class="text-3xl font-bold animate-pulse">Cargando...</h1>
    </div>

    <!-- Login/Home Screen -->
    <div id="loginScreen" class="hidden h-screen flex items-center justify-center">
        <div class="container card text-center">
            <h1 class="text-4xl font-bold mb-6">Impostor Futbolero</h1>
            <input type="text" id="playerNameInput" placeholder="Introduce tu nombre" class="input-field w-full p-3 rounded-lg mb-4 text-center">
            <div class="space-y-4 md:space-y-0 md:flex md:space-x-4">
                <button id="createRoomBtn" class="btn btn-primary w-full md:w-1/2 p-3 rounded-lg font-semibold text-lg">Crear Sala</button>
                <div class="w-full md:w-1/2 flex space-x-2">
                    <input type="text" id="joinRoomInput" placeholder="Código de sala" class="input-field w-2/3 p-3 rounded-lg text-center uppercase">
                    <button id="joinRoomBtn" class="btn btn-secondary w-1/3 p-3 rounded-lg font-semibold text-lg">Unirse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 class="text-3xl font-bold mb-4">Sala de Juego</h2>
            <p class="text-xl mb-4">Código: <span id="roomCodeDisplay" class="font-bold text-yellow-400"></span></p>
            <p class="text-lg mb-2">Jugadores:</p>
            <ul id="lobbyPlayersList" class="mb-6 space-y-2">
                <!-- Player list will be rendered here -->
            </ul>
            <button id="startGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl hidden">Empezar Juego</button>
            <p class="text-sm mt-4 text-gray-500">Comparte el código con tus amigos para que se unan.</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <div id="roleCard" class="role-card">
                <!-- Role will be rendered here -->
            </div>
            
            <div class="mt-8 w-full">
                <h3 class="text-2xl font-bold mb-4">Jugadores</h3>
                <ul id="gamePlayersList" class="mb-6 space-y-2">
                    <!-- Player list with elimination options -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 id="gameOverMessage" class="text-4xl font-bold mb-4 text-center"></h2>
            <button id="newGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl hidden">Volver a Jugar</button>
        </div>
    </div>

</body>
</html>
