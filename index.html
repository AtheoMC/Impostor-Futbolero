<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Futbolero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            overflow: hidden;
        }
        .container {
            max-width: 90%;
            margin: auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #1E1E1E;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .input-field {
            background-color: #2E2E2E;
            border: 1px solid #444;
            color: #E0E0E0;
        }
        .btn {
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #1a75ff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1059c9;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #333;
            color: #E0E0E0;
        }
        .btn-secondary:hover {
            background-color: #222;
            transform: translateY(-2px);
        }
        .btn-green {
            background-color: #28a745;
            color: white;
        }
        .btn-green:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .role-card {
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            background-color: #2E2E2E;
            text-align: center;
        }
        .futbolista-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            margin: 1rem auto;
        }
        #countdownTimer {
            font-size: 3rem;
            font-weight: bold;
            color: #fca5a5;
        }
        .player-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #2e2e2e;
        }
        .player-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
        }
        .player-impostor {
            color: #ef4444; /* Rojo para el impostor */
            font-weight: bold;
        }
        .player-normal {
            color: #4ade80; /* Verde para los jugadores normales */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Pantalla de Carga -->
    <div id="loadingScreen" class="h-screen flex items-center justify-center">
        <h1 class="text-3xl font-bold animate-pulse">Cargando...</h1>
    </div>

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="hidden h-screen flex items-center justify-center">
        <div class="container card text-center">
            <h1 class="text-4xl font-bold mb-6">Impostor Futbolero</h1>
            <input type="text" id="playerNameInput" placeholder="Ingresa tu nombre" class="input-field w-full p-4 mb-4 rounded-lg">
            <div class="space-y-4">
                <button id="createRoomBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl">Crear Sala</button>
                <div class="flex items-center justify-center space-x-2">
                    <input type="text" id="roomCodeInput" placeholder="Código de Sala" class="input-field p-3 rounded-lg w-2/3">
                    <button id="joinRoomBtn" class="btn btn-secondary w-1/3 p-3 rounded-lg font-semibold text-lg">Unirse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla del Lobby -->
    <div id="lobbyScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 class="text-3xl font-bold mb-4">Sala de Juego</h2>
            <p class="text-xl mb-4">Código: <span id="roomCodeDisplay" class="font-bold text-yellow-400"></span></p>
            <p class="text-lg mb-2">Jugadores:</p>
            <ul id="lobbyPlayersList" class="mb-6 space-y-2"></ul>
            
            <!-- Contador para el inicio del juego -->
            <div id="countdownTimer" class="hidden mb-6">10</div>

            <button id="startGameBtn" class="btn btn-green w-full p-4 rounded-lg font-semibold text-xl hidden">Empezar Juego</button>
            <p class="text-sm mt-4 text-gray-500">Comparte el código con tus amigos para que se unan.</p>
        </div>
    </div>

    <!-- Pantalla de Juego -->
    <div id="gameScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <div id="roleCard" class="role-card"></div>
            <div class="mt-8 w-full">
                <h3 class="text-2xl font-bold mb-4">Jugadores</h3>
                <ul id="gamePlayersList" class="mb-6 space-y-2"></ul>
            </div>
            <button id="endGameBtn" class="btn btn-secondary w-full p-4 rounded-lg font-semibold text-xl mt-4">Terminar Partida</button>
        </div>
    </div>

    <!-- Pantalla de Fin de Juego -->
    <div id="gameOverScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 id="gameOverMessage" class="text-4xl font-bold mb-4"></h2>
            <p id="impostorReveal" class="text-xl mb-6"></p>
            <button id="newGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl">Nueva Partida</button>
        </div>
    </div>

    <!-- Importaciones y Scripts -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let myUserId = crypto.randomUUID(); // Genera un ID de usuario inmediatamente
        let currentRoomCode = '';
        let roomDocRef = null;
        let unsubscribeFromRoom = null;
        let countdownInterval = null;

        // Se inicia sesión anónimamente en segundo plano para las operaciones de la base de datos
        // La UI ya no espera a que esto termine
        signInAnonymously(auth).then(userCredential => {
            console.log("Sesión de usuario anónimo iniciada con UID:", userCredential.user.uid);
            myUserId = userCredential.user.uid;
        }).catch(error => {
            console.error("Error al iniciar sesión anónimamente:", error);
        });

        // Lista de Futbolistas y sus fotos
        const futbolistas = [
            "Pelé", "Diego Maradona", "Lionel Messi", "Cristiano Ronaldo", "Zinedine Zidane",
            "Johan Cruyff", "Franz Beckenbauer", "Ferenc Puskás", "Alfredo Di Stéfano", "Garrincha",
            "Michel Platini", "Lev Yashin", "Eusébio", "Ronaldo Nazário", "Marco van Basten",
            "Bobby Charlton", "George Best", "Gerd Müller", "Paolo Maldini", "Bebeto",
            "Romário", "Ronaldinho", "Kaká", "Thierry Henry", "Raúl González",
            "Andrés Iniesta", "Xavi Hernández", "Luka Modrić", "Sergio Ramos", "Iker Casillas",
            "Gianluigi Buffon", "Andrea Pirlo", "Alessandro Del Piero", "Francesco Totti", "Roberto Baggio",
            "Dennis Bergkamp", "Ruud Gullit", "Frank Rijkaard", "Edwin van der Sar", "Kylian Mbappé",
            "Erling Haaland", "Neymar Jr.", "Mohamed Salah", "Kevin De Bruyne", "Harry Kane",
            "Robert Lewandowski", "Karim Benzema", "Luis Suárez", "Arjen Robben", "Franck Ribéry",
            "Manuel Neuer", "Alisson Becker", "Thibaut Courtois", "Virgil van Dijk", "Sergio Agüero",
            "David Beckham", "Paul Scholes", "Ryan Giggs", "Steven Gerrard", "Frank Lampard",
            "Didier Drogba", "Samuel Eto'o", "Michael Essien", "Yaya Touré", "Daniele De Rossi",
            "N'Golo Kanté", "Patrick Vieira", "Claude Makélélé", "Thiago Silva", "Giorgio Chiellini",
            "Leonardo Bonucci", "José Mourinho", "Pep Guardiola", "Jürgen Klopp", "Carlo Ancelotti",
            "Arsène Wenger", "Sir Alex Ferguson", "Diego Simeone", "Marc Overmars", "Javier Zanetti",
            "Gabriel Batistuta", "Hernán Crespo", "Juan Román Riquelme", "Ariel Ortega", "Marcelo Salas",
            "Iván Zamorano", "Carlos Valderrama", "René Higuita", "Jorge Campos", "Hugo Sánchez",
            "Claudio Caniggia", "Enzo Francescoli", "Alexis Sánchez", "Arturo Vidal", "Keylor Navas",
            "Hirving Lozano", "Alphonso Davies", "Christian Pulisic", "Shinji Kagawa", "Heung-min Son",
            "Mohamed Aboutrika", "Wael Gomaa", "Hossam Hassan", "Essam El-Hadary", "Mido",
            "Javier Pastore", "Gonzalo Higuaín", "Ángel Di María", "Paulo Dybala", "Juan Sebastián Verón",
            "Juan Arango", "Salomón Rondón", "Tomás Rincón", "Oswaldo Vizcarrondo", "José Manuel Rey",
            "Gabriel Cichero", "Yeferson Soteldo", "Josef Martínez", "Wuilker Fariñez", "Fernando Amorebieta"
        ];
        
        const fotosFutbolistas = {
            "Lionel Messi": "https://upload.wikimedia.org/wikipedia/commons/b/b4/Lionel-Messi-Argentina-2022-FIFA-World-Cup_%28cropped%29.jpg",
            "Cristiano Ronaldo": "https://upload.wikimedia.org/wikipedia/commons/d/d7/Cristiano_Ronaldo_2018.jpg",
            "Zinedine Zidane": "https://upload.wikimedia.org/wikipedia/commons/e/e9/Zinedine_Zidane_2006.jpg",
            "Pelé": "https://upload.wikimedia.org/wikipedia/commons/b/b3/Pele_1970_cropped.jpg",
            "Diego Maradona": "https://upload.wikimedia.org/wikipedia/commons/d/d4/Diego_Maradona_1986.jpg",
            "Kylian Mbappé": "https://upload.wikimedia.org/wikipedia/commons/b/b3/Kylian_Mbapp%C3%A9_2022.jpg",
            "Neymar Jr.": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Neymar_Jr_PSG_2022.jpg/800px-Neymar_Jr_PSG_2022.jpg",
            "Erling Haaland": "https://upload.wikimedia.org/wikipedia/commons/a/ae/Erling_Haaland_2022.jpg",
            "Johan Cruyff": "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Johan_Cruyff_1974b.JPG/800px-Johan_Cruyff_1974b.JPG",
            "Franz Beckenbauer": "https://upload.wikimedia.org/wikipedia/commons/e/ec/Franz_Beckenbauer_1974.jpg",
            "Ronaldo Nazário": "https://upload.wikimedia.org/wikipedia/commons/d/d4/Ronaldo_Naz%C3%A1rio_2018.jpg"
            // Puedes añadir más futbolistas y sus URLs de fotos aquí
        };

        // URLs de avatares para los jugadores
        const avatarUrls = [
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-370-456322.png",
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-372-456324.png",
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-369-456321.png",
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-373-456325.png",
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-367-456319.png",
            "https://cdn.iconscout.com/icon/free/png-256/free-avatar-375-456327.png"
        ];

        // Elementos del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const playerNameInput = document.getElementById('playerNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const lobbyPlayersList = document.getElementById('lobbyPlayersList');
        const gamePlayersList = document.getElementById('gamePlayersList');
        const startGameBtn = document.getElementById('startGameBtn');
        const roleCard = document.getElementById('roleCard');
        const countdownTimer = document.getElementById('countdownTimer');
        const newGameBtn = document.getElementById('newGameBtn');
        const endGameBtn = document.getElementById('endGameBtn');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const impostorReveal = document.getElementById('impostorReveal');

        // Función para cambiar de pantalla
        function switchScreen(screen) {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        // Mostrar la pantalla de inicio una vez que el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
            switchScreen(loginScreen);
        });

        // Función para generar un código de sala aleatorio
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // Función para obtener la URL de la foto del jugador (ahora usa avatares aleatorios)
        function getPlayerPhoto() {
            return avatarUrls[Math.floor(Math.random() * avatarUrls.length)];
        }

        // Función para actualizar la lista de jugadores en la UI
        function updatePlayersList(players, listElement, impostorId = null) {
            listElement.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                
                // Añadir la imagen del jugador
                const playerPhoto = document.createElement('img');
                playerPhoto.className = 'player-photo';
                playerPhoto.src = player.photoURL;
                playerPhoto.onerror = function() {
                    // Fallback si el avatar no carga
                    this.src = 'https://placehold.co/40x40/000000/FFFFFF?text=P';
                };
                
                const playerName = document.createElement('span');
                playerName.textContent = player.name;
                playerName.className = 'text-xl';

                li.appendChild(playerPhoto);
                li.appendChild(playerName);
                listElement.appendChild(li);

                if (impostorId !== null) {
                    if (player.id === impostorId) {
                        li.classList.add('player-impostor');
                    } else {
                        li.classList.add('player-normal');
                    }
                }
            });
        }

        // Funcionalidad de crear sala
        createRoomBtn.addEventListener('click', async () => {
            const myPlayerName = playerNameInput.value.trim();
            if (!myPlayerName) {
                console.error("El nombre de jugador no puede estar vacío.");
                return;
            }

            const newRoomCode = generateRoomCode();
            const player = {
                id: myUserId,
                name: myPlayerName,
                isHost: true,
                photoURL: getPlayerPhoto(), // Usar la nueva función para avatares
            };

            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, newRoomCode);
            try {
                await setDoc(roomRef, {
                    roomCode: newRoomCode,
                    gameStatus: 'lobby',
                    players: [player],
                    hostId: myUserId,
                    impostorId: null,
                    futbolista: null
                });

                currentRoomCode = newRoomCode;
                roomDocRef = roomRef;
                subscribeToRoom();
                roomCodeDisplay.textContent = newRoomCode;
                startGameBtn.classList.remove('hidden');
                switchScreen(lobbyScreen);
            } catch (e) {
                console.error("Error al crear la sala:", e);
            }
        });

        // Funcionalidad de unirse a sala
        joinRoomBtn.addEventListener('click', async () => {
            const myPlayerName = playerNameInput.value.trim();
            const roomCode = roomCodeInput.value.trim().toUpperCase();

            if (!myPlayerName || !roomCode) {
                console.error("El nombre de jugador o el código de sala no pueden estar vacíos.");
                return;
            }

            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomCode);
            const roomSnap = await getDoc(roomRef);

            if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                if (roomData.gameStatus === 'lobby') {
                    const newPlayer = {
                        id: myUserId,
                        name: myPlayerName,
                        isHost: false,
                        photoURL: getPlayerPhoto(), // Usar la nueva función para avatares
                    };
                    try {
                        await updateDoc(roomRef, {
                            players: arrayUnion(newPlayer)
                        });

                        currentRoomCode = roomCode;
                        roomDocRef = roomRef;
                        subscribeToRoom();
                        roomCodeDisplay.textContent = roomCode;
                        switchScreen(lobbyScreen);
                    } catch (e) {
                        console.error("Error al unirse a la sala:", e);
                    }
                } else {
                    console.error("La partida ya ha comenzado.");
                }
            } else {
                console.error("Sala no encontrada.");
            }
        });

        // Suscribirse a los cambios en la sala
        function subscribeToRoom() {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
            }
            unsubscribeFromRoom = onSnapshot(roomDocRef, (doc) => {
                if (!doc.exists()) {
                    console.log("La sala ha sido eliminada.");
                    // Manejar la salida de la sala, por ejemplo, volver a la pantalla de inicio
                    switchScreen(loginScreen);
                    return;
                }
                const roomData = doc.data();
                const players = roomData.players;
                const hostId = roomData.hostId;
                const gameStatus = roomData.gameStatus;
                const impostorId = roomData.impostorId;
                const futbolista = roomData.futbolista;

                // Actualizar la lista de jugadores en ambas pantallas (lobby y juego)
                updatePlayersList(players, lobbyPlayersList);
                updatePlayersList(players, gamePlayersList);

                // Lógica de estado de la partida
                switch (gameStatus) {
                    case 'lobby':
                        // Ocultar el contador si está visible
                        countdownTimer.classList.add('hidden');
                        if (myUserId === hostId) {
                            startGameBtn.classList.remove('hidden');
                        }
                        break;
                    case 'countdown':
                        switchScreen(lobbyScreen);
                        startGameBtn.classList.add('hidden');
                        countdownTimer.classList.remove('hidden');
                        // Iniciar el temporizador si aún no ha comenzado
                        startCountdown(roomData.countdownStartTimestamp);
                        break;
                    case 'ingame':
                        // Asegurarse de que el juego realmente comience
                        switchScreen(gameScreen);
                        const myPlayer = players.find(p => p.id === myUserId);
                        const myRole = myPlayer.isImpostor ? 'impostor' : 'normal';
                        displayRole(myRole, futbolista);
                        updatePlayersList(players, gamePlayersList, impostorId);
                        break;
                    case 'gameover':
                        switchScreen(gameOverScreen);
                        gameOverMessage.textContent = roomData.winnerMessage;
                        impostorReveal.textContent = `El impostor era: ${players.find(p => p.id === impostorId).name}`;
                        break;
                }
            });
        }

        // Iniciar el contador
        startGameBtn.addEventListener('click', async () => {
            await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomDocRef);
                const roomData = roomDoc.data();
                
                if (roomData.hostId !== myUserId) {
                    throw "Solo el anfitrión puede iniciar el juego.";
                }
                
                if (roomData.players.length < 3) {
                    console.error("Se necesitan al menos 3 jugadores para empezar.");
                    return;
                }
                
                // Asignar roles y un futbolista aleatorio de forma atómica
                const shuffledPlayers = [...roomData.players].sort(() => 0.5 - Math.random());
                const impostorIndex = Math.floor(Math.random() * shuffledPlayers.length);
                const impostorId = shuffledPlayers[impostorIndex].id;
                
                const randomFutbolista = futbolistas[Math.floor(Math.random() * futbolistas.length)];
                
                const updatedPlayers = roomData.players.map(player => ({
                    ...player,
                    isImpostor: player.id === impostorId
                }));
                
                transaction.update(roomDocRef, {
                    gameStatus: 'countdown',
                    countdownStartTimestamp: new Date().getTime(),
                    impostorId: impostorId,
                    futbolista: randomFutbolista,
                    players: updatedPlayers
                });
            });
        });

        // Lógica del temporizador
        function startCountdown(startTime) {
            clearInterval(countdownInterval); // Limpiar cualquier temporador anterior
            const countdownDuration = 10; // 10 segundos
            countdownInterval = setInterval(async () => {
                const elapsedTime = (new Date().getTime() - startTime) / 1000;
                const remainingTime = Math.ceil(countdownDuration - elapsedTime);
                
                if (remainingTime > 0) {
                    countdownTimer.textContent = remainingTime;
                } else {
                    clearInterval(countdownInterval);
                    countdownTimer.classList.add('hidden');
                    
                    await runTransaction(db, async (transaction) => {
                        const roomDoc = await transaction.get(roomDocRef);
                        const roomData = roomDoc.data();

                        // Prevenir que múltiples clientes cambien el estado
                        if (roomData.gameStatus === 'countdown') {
                            transaction.update(roomDocRef, { gameStatus: 'ingame' });
                        }
                    });
                }
            }, 1000);
        }

        // Mostrar el rol del jugador y la imagen del futbolista si aplica
        function displayRole(role, futbolista) {
            roleCard.innerHTML = ''; // Limpiar el contenido anterior

            const roleHeading = document.createElement('h3');
            roleHeading.className = 'text-3xl font-bold mb-2';

            const roleText = document.createElement('p');
            roleText.className = 'text-lg';

            if (role === 'impostor') {
                roleHeading.textContent = '¡Eres el Impostor!';
                roleHeading.classList.add('text-red-500');
                roleText.textContent = 'Tu objetivo es eliminar a los demás jugadores sin ser descubierto. No sabes quién es el futbolista.';
                
                roleCard.appendChild(roleHeading);
                roleCard.appendChild(roleText);

            } else {
                roleHeading.textContent = '¡Eres del Equipo!';
                roleHeading.classList.add('text-green-500');

                const futbolistaPhoto = document.createElement('img');
                futbolistaPhoto.className = 'futbolista-photo';
                // Obtener la URL de la foto del futbolista
                const photoURL = fotosFutbolistas[futbolista] || 'https://placehold.co/150x150/000000/FFFFFF?text=FUTBOLISTA';
                futbolistaPhoto.src = photoURL;
                futbolistaPhoto.alt = `Foto de ${futbolista}`;

                roleText.innerHTML = `El futbolista es: <span class="font-bold text-yellow-400">${futbolista}</span>. Tu objetivo es identificar al impostor. Habla sobre el futbolista para descubrir quién no sabe de qué hablas.`;

                roleCard.appendChild(roleHeading);
                roleCard.appendChild(futbolistaPhoto); // Añadir la imagen
                roleCard.appendChild(roleText);
            }
        }
        
        // Lógica de fin de partida (ejemplo)
        endGameBtn.addEventListener('click', async () => {
            const roomData = (await getDoc(roomDocRef)).data();
            if (myUserId === roomData.hostId) {
                await updateDoc(roomDocRef, {
                    gameStatus: 'gameover',
                    winnerMessage: '¡El juego ha terminado!',
                });
            }
        });

        newGameBtn.addEventListener('click', async () => {
             await runTransaction(db, async (transaction) => {
                const roomDoc = await transaction.get(roomDocRef);
                const roomData = roomDoc.data();
                
                const updatedPlayers = roomData.players.map(p => ({ 
                    id: p.id, 
                    name: p.name, 
                    isHost: p.isHost,
                    photoURL: getPlayerPhoto(), // Usar la nueva función para avatares
                    isImpostor: false,
                }));

                transaction.update(roomDocRef, {
                    gameStatus: 'lobby',
                    impostorId: null,
                    futbolista: null,
                    players: updatedPlayers
                });
            });
            switchScreen(lobbyScreen);
        });
    </script>
</body>
</html>
