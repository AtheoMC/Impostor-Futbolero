<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Futbolero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 90%;
            margin: auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #1E1E1E;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .input-field {
            background-color: #2E2E2E;
            border: 1px solid #444;
            color: #E0E0E0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        .btn {
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        .btn-primary {
            background-color: #4F46E5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338CA;
        }
        .btn-secondary {
            background-color: #1E40AF;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #1E3A8A;
        }
        .role-card {
            padding: 2rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid;
            animation: fadeIn 1s ease-in-out;
        }
        .impostor-card {
            background-color: #6C1E1E;
            border-color: #DC2626;
        }
        .crewmate-card {
            background-color: #1E4D3E;
            border-color: #10B981;
        }
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: #2E2E2E;
            border-radius: 0.75rem;
            border: 1px solid #333;
        }
        .player-item.voted {
            background-color: #4338CA;
        }
        .player-name {
            font-weight: 600;
        }
        .vote-btn-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        .vote-btn {
            background-color: #2E2E2E;
            color: #E0E0E0;
            border: 1px solid #444;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .vote-btn:hover {
            background-color: #3B3B3B;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h1 class="text-4xl font-bold mb-6">Impostor Futbolero</h1>
            <p class="text-lg mb-4">Descubre quién es el impostor del fútbol.</p>
            <input id="playerNameInput" type="text" placeholder="Tu nombre" class="input-field mb-4">
            <button id="createRoomBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl mb-4">Crear Sala</button>
            <div class="flex items-center space-x-2">
                <input id="roomIdInput" type="text" placeholder="Código de sala" class="input-field flex-grow text-center uppercase">
                <button id="joinRoomBtn" class="btn btn-secondary p-4 rounded-lg font-semibold text-xl">Unirse</button>
            </div>
        </div>
    </div>

    <div id="lobbyScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 class="text-3xl font-bold mb-4">Sala de Juego</h2>
            <p class="text-xl mb-4">Código: <span id="roomCodeDisplay" class="font-bold text-yellow-400"></span></p>
            <p class="text-lg mb-2">Jugadores:</p>
            <ul id="lobbyPlayersList" class="mb-6 space-y-2"></ul>
            <button id="startGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl hidden">Empezar Juego</button>
            <p class="text-sm mt-4 text-gray-500">Comparte el código con tus amigos para que se unan.</p>
        </div>
    </div>

    <div id="gameScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <div id="roleCard" class="role-card"></div>
            <div class="mt-8 w-full">
                <h3 class="text-2xl font-bold mb-4">Jugadores</h3>
                <ul id="gamePlayersList" class="mb-6 space-y-2"></ul>
            </div>
            <button id="endGameBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl">Iniciar Votación</button>
        </div>
    </div>

    <div id="votingScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 class="text-3xl font-bold mb-4">Votación</h2>
            <p class="text-lg mb-4">¿Quién es el impostor?</p>
            <div id="votingList" class="vote-btn-container mb-6"></div>
        </div>
    </div>

    <div id="gameOverScreen" class="hidden h-screen flex flex-col items-center justify-center">
        <div class="container card text-center">
            <h2 id="gameOverMessage" class="text-4xl font-bold mb-4"></h2>
            <p id="gameOverSubMessage" class="text-xl mb-6"></p>
            <button id="playAgainBtn" class="btn btn-primary w-full p-4 rounded-lg font-semibold text-xl">Jugar de Nuevo</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const __app_id = 'el_impostor_futbolero';
        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyCumowABsEKfX_js3s0KjdIGi0Oor6MXvA","authDomain":"impostor-futbolero-online.firebaseapp.com","projectId":"impostor-futbolero-online","storageBucket":"impostor-futbolero-online.firebasestorage.app","messagingSenderId":"1067586840575","appId":"1:1067586840575:web:32889c085f7cf461bfa9ca","measurementId":"G-W7NY2T2V2C"}');
        // --- End of Firebase Configuration ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let playerName = "";
        let currentRoomId = "";
        let playerIsImpostor = false;
        let secretPlayerName = "";

        const screens = {
            login: document.getElementById('loginScreen'),
            lobby: document.getElementById('lobbyScreen'),
            game: document.getElementById('gameScreen'),
            voting: document.getElementById('votingScreen'),
            gameOver: document.getElementById('gameOverScreen')
        };
        
        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        };

        const footballPlayers = [
            "Lionel Messi", "Cristiano Ronaldo", "Neymar Jr.", "Kylian Mbappé", "Kevin De Bruyne",
            "Erling Haaland", "Robert Lewandowski", "Karim Benzema", "Mohamed Salah", "Luka Modrić",
            "Harry Kane", "Sadio Mané", "Virgil van Dijk", "Alisson Becker", "Thibaut Courtois",
            "Manuel Neuer", "Joshua Kimmich", "Toni Kroos", "Vinícius Júnior", "Pedri",
            "Gavi", "Ferran Torres", "João Félix", "Bernardo Silva", "Bruno Fernandes",
            "Phil Foden", "Jack Grealish", "Marcus Rashford", "Jadon Sancho", "Declan Rice",
            "Jude Bellingham", "Bukayo Saka", "Mason Mount", "Kai Havertz", "Timo Werner",
            "Serge Gnabry", "Leon Goretzka", "Ilkay Gündoğan", "Leroy Sané", "Ansu Fati",
            "Ousmane Dembélé", "Frenkie de Jong", "Memphis Depay", "Julián Álvarez", "Lautaro Martínez",
            "Paulo Dybala", "Ángel Di María", "N'Golo Kanté", "Paul Pogba", "Antoine Griezmann",
            "Olivier Giroud", "Romelu Lukaku", "Kevin Mbabu", "Federico Chiesa", "Marco Verratti",
            "Jorginho", "Alessandro Bastoni", "Gianluigi Donnarumma", "Koke", "Álvaro Morata",
            "David de Gea", "Jan Oblak", "Ederson", "Casemiro", "Eder Militão",
            "Raphinha", "Gabriel Jesus", "Richarlison", "Dani Alves", "Marcelo",
            "Sergio Ramos", "Gerard Piqué", "Ronald Araújo", "Darwin Núñez", "Luis Díaz",
            "Luis Suárez", "Edinson Cavani", "Giorgio Chiellini", "Leonardo Bonucci", "Lorenzo Insigne",
            "Ciro Immobile", "Dries Mertens", "Eden Hazard", "Christian Eriksen", "Heung-min Son",
            "Takefusa Kubo", "Shinji Kagawa", "Achraf Hakimi", "Zlatan Ibrahimović", "Gareth Bale",
            "David Alaba", "Dušan Vlahović", "Kalidou Koulibaly", "André Onana", "Salomón Rondón",
            "Juan Arango", "Yeferson Soteldo", "Diego Maradona", "Pelé", "Alfredo Di Stéfano",
            "Johan Cruyff", "Franz Beckenbauer", "Marco van Basten", "George Best", "Michel Platini",
            "Zinedine Zidane", "Ronaldo Nazário", "Ronaldinho", "Kaká", "Thierry Henry",
            "Dennis Bergkamp", "Paolo Maldini", "Roberto Baggio", "Andrea Pirlo", "Iker Casillas",
            "Xavi Hernández", "Andrés Iniesta", "David Villa", "Fernando Torres", "Francesco Totti",
            "Gigi Buffon", "Steven Gerrard", "Frank Lampard", "Didier Drogba", "Arjen Robben",
            "Wesley Sneijder", "Robin van Persie", "Wayne Rooney", "Carlos Tevez", "Luis Figo",
            "Raúl González", "Sergio Agüero", "Diego Forlán", "Alexis Sánchez", "Arturo Vidal",
            "Claudio Bravo", "James Rodríguez", "Radamel Falcao", "Keylor Navas", "Hugo Lloris",
            "Raphaël Varane", "Mats Hummels", "Manuel Neuer", "Thomas Müller", "Marco Reus",
            "Mesut Özil", "Mario Götze", "Sami Khedira", "Miroslav Klose", "Gigi Buffon",
            "Andrea Barzagli", "Leonardo Bonucci", "Giorgio Chiellini", "Dani Carvajal", "Jordi Alba",
            "Dani Alves", "Marcelo", "Nacho", "Pepe", "Gabriel Heinze",
            "Juan Román Riquelme", "Ariel Ortega", "Javier Saviola", "Hernán Crespo", "Batistuta",
            "Claudio Caniggia", "Ronald Koeman", "Ruud Gullit", "Frank Rijkaard", "Dennis Bergkamp",
            "Marc Overmars", "Clarence Seedorf", "Edgar Davids", "Michael Owen", "Alan Shearer",
            "Rio Ferdinand", "John Terry", "Ashley Cole", "Steven Gerrard", "Frank Lampard",
            "Didier Drogba", "Samuel Eto'o", "Patrick Vieira", "Michael Ballack", "Philipp Lahm",
            "Miroslav Klose", "Lothar Matthäus", "Karl-Heinz Rummenigge", "Oliver Kahn", "Toni Kroos",
            "Luka Modrić", "Ivan Rakitić", "Kevin De Bruyne", "Thibaut Courtois", "Eden Hazard",
            "Romelu Lukaku", "Jan Vertonghen", "Christian Eriksen", "Kasper Schmeichel", "Peter Schmeichel",
            "Henrik Larsson", "Anders Svensson", "Sebastian Larsson", "Nani", "Ricardo Quaresma",
            "João Moutinho", "Pepe", "Renato Sanches", "Luis Figo", "Rui Costa",
            "Ricardo Carvalho", "Deco", "Fabio Cannavaro", "Alessandro Del Piero", "Filippo Inzaghi",
            "Andrea Pirlo", "Marco Materazzi", "Gennaro Gattuso", "Luca Toni", "Mario Balotelli",
            "Thiago Silva", "Neymar Jr.", "Gabriel Martinelli", "Rodrygo", "Alphonso Davies",
            "Christian Pulisic", "Giovanni Reyna", "Weston McKennie", "Hirving Lozano", "Guillermo Ochoa",
            "Raúl Jiménez", "Alexis Vega", "Keylor Navas", "Joel Campbell", "Brian Ruiz",
            "Salomón Rondón", "Juan Arango", "Yeferson Soteldo", "Jefferson Farfán", "Paolo Guerrero",
            "Claudio Pizarro", "Arturo Vidal", "Alexis Sánchez", "Gary Medel", "James Rodríguez",
            "Luis Díaz", "Radamel Falcao", "Alphonso Davies", "Jonathan David", "Tajon Buchanan",
            "Cyle Larin", "Atiba Hutchinson", "Stephen Eustaquio", "Ismaël Koné"
        ];

        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('endGameBtn').addEventListener('click', startVotingPhase);
        document.getElementById('playAgainBtn').addEventListener('click', () => window.location.reload());

        const createRoom = async () => {
            playerName = document.getElementById('playerNameInput').value;
            if (!playerName) return alert('Por favor, introduce un nombre.');

            currentRoomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
            
            await setDoc(roomRef, {
                status: 'waiting',
                secretPlayer: '',
                players: [{ id: currentUserId, name: playerName, role: 'crewmate', vote: null }]
            });
            
            setupRoomListener();
            showScreen('lobby');
        };

        const joinRoom = async () => {
            playerName = document.getElementById('playerNameInput').value;
            currentRoomId = document.getElementById('roomIdInput').value.toUpperCase();
            if (!playerName || !currentRoomId) return alert('Por favor, introduce un nombre y un código de sala.');

            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
            const roomSnap = await getDoc(roomRef);

            if (!roomSnap.exists()) {
                return alert('La sala no existe.');
            }

            const roomData = roomSnap.data();
            const existingPlayer = roomData.players.find(p => p.id === currentUserId);
            if (existingPlayer) {
                alert('Ya te uniste a esta sala.');
                setupRoomListener();
                showScreen('lobby');
                return;
            }
            
            roomData.players.push({ id: currentUserId, name: playerName, role: 'crewmate', vote: null });
            await setDoc(roomRef, roomData);

            setupRoomListener();
            showScreen('lobby');
        };

        const setupRoomListener = () => {
            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
            onSnapshot(roomRef, (doc) => {
                if (!doc.exists()) {
                    alert('La sala ha sido eliminada. Volviendo a la pantalla de inicio.');
                    window.location.reload();
                    return;
                }
                const roomData = doc.data();
                renderUI(roomData);
            });
        };

        const renderUI = (roomData) => {
            switch (roomData.status) {
                case 'waiting':
                    document.getElementById('roomCodeDisplay').textContent = currentRoomId;
                    const lobbyPlayersList = document.getElementById('lobbyPlayersList');
                    lobbyPlayersList.innerHTML = roomData.players.map(p => `<li class="player-item"><span class="player-name">${p.name}</span></li>`).join('');
                    const startGameBtn = document.getElementById('startGameBtn');
                    if (roomData.players.length >= 3) {
                        startGameBtn.classList.remove('hidden');
                    } else {
                        startGameBtn.classList.add('hidden');
                    }
                    showScreen('lobby');
                    break;

                case 'playing':
                    secretPlayerName = roomData.secretPlayer;
                    const myPlayer = roomData.players.find(p => p.id === currentUserId);
                    playerIsImpostor = myPlayer.role === 'impostor';
                    
                    const roleCard = document.getElementById('roleCard');
                    roleCard.classList.remove('impostor-card', 'crewmate-card');
                    
                    let roleMessage = "";
                    if (playerIsImpostor) {
                        roleCard.classList.add('impostor-card');
                        roleMessage = "Eres el Impostor. Tu objetivo es que nadie descubra que no sabes quién es el jugador secreto. ¡Adivina su nombre y gana!";
                    } else {
                        roleCard.classList.add('crewmate-card');
                        roleMessage = `Eres un Tripulante. El jugador secreto es: <strong>${secretPlayerName}</strong>.`;
                    }
                    roleCard.innerHTML = `<h3 class="text-2xl font-bold">${playerIsImpostor ? '¡Eres el Impostor!' : '¡Eres Tripulante!'}</h3><p class="mt-2">${roleMessage}</p>`;
                    
                    const gamePlayersList = document.getElementById('gamePlayersList');
                    gamePlayersList.innerHTML = roomData.players.map(p => `
                        <li class="player-item">
                            <span class="player-name">${p.name}</span>
                            <span class="text-sm text-gray-400">ID: ${p.id.substring(0, 8)}...</span>
                        </li>
                    `).join('');
                    
                    showScreen('game');
                    break;
                
                case 'voting':
                    const votingList = document.getElementById('votingList');
                    votingList.innerHTML = roomData.players.map(p => `
                        <button class="vote-btn" data-player-id="${p.id}">
                            ${p.name}
                        </button>
                    `).join('');

                    document.querySelectorAll('.vote-btn').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const votedPlayerId = btn.dataset.playerId;
                            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
                            const updatedPlayers = roomData.players.map(p => {
                                if (p.id === currentUserId) p.vote = votedPlayerId;
                                return p;
                            });
                            await setDoc(roomRef, { ...roomData, players: updatedPlayers });
                        }, { once: true });
                    });
                    
                    const myPlayerVote = roomData.players.find(p => p.id === currentUserId)?.vote;
                    if (myPlayerVote) {
                        document.querySelector(`button[data-player-id="${myPlayerVote}"]`).classList.add('voted');
                    }

                    showScreen('voting');
                    checkVotingStatus(roomData);
                    break;

                case 'results':
                    const gameOverMessage = document.getElementById('gameOverMessage');
                    const gameOverSubMessage = document.getElementById('gameOverSubMessage');

                    const eliminatedPlayer = roomData.players.find(p => p.id === roomData.eliminatedPlayerId);
                    
                    if (roomData.winner === 'crewmate') {
                        gameOverMessage.textContent = '¡Tripulantes Ganaron!';
                        gameOverSubMessage.textContent = `El impostor ha sido descubierto. Era ${eliminatedPlayer.name}.`;
                    } else {
                        gameOverMessage.textContent = '¡Impostor Ganó!';
                        gameOverSubMessage.textContent = `La tripulación falló. El impostor era ${eliminatedPlayer.name}.`;
                    }
                    showScreen('gameOver');
                    break;
            }
        };

        const startGame = async () => {
            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();
            
            const impostorIndex = Math.floor(Math.random() * roomData.players.length);
            const secretPlayer = footballPlayers[Math.floor(Math.random() * footballPlayers.length)];
            
            const updatedPlayers = roomData.players.map((player, index) => {
                const role = index === impostorIndex ? 'impostor' : 'crewmate';
                return { ...player, role, vote: null };
            });
            
            await setDoc(roomRef, {
                ...roomData,
                status: 'playing',
                secretPlayer,
                players: updatedPlayers
            });
        };

        const startVotingPhase = async () => {
            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);
            await setDoc(roomRef, { ...roomData, status: 'voting' });
        };
        
        const checkVotingStatus = (roomData) => {
            const votes = {};
            let allVoted = true;
            roomData.players.forEach(p => {
                if (p.vote === null) {
                    allVoted = false;
                }
                if (p.vote) {
                    votes[p.vote] = (votes[p.vote] || 0) + 1;
                }
            });

            if (allVoted) {
                resolveVoting(votes, roomData);
            }
        };

        const resolveVoting = async (votes, roomData) => {
            let maxVotes = 0;
            let tiedPlayers = [];
            for (const playerId in votes) {
                if (votes[playerId] > maxVotes) {
                    maxVotes = votes[playerId];
                    tiedPlayers = [playerId];
                } else if (votes[playerId] === maxVotes) {
                    tiedPlayers.push(playerId);
                }
            }

            const eliminatedPlayerId = tiedPlayers[Math.floor(Math.random() * tiedPlayers.length)];
            const eliminatedPlayer = roomData.players.find(p => p.id === eliminatedPlayerId);
            
            const roomRef = doc(db, 'artifacts', __app_id, 'public', 'data', 'rooms', currentRoomId);

            if (eliminatedPlayer.role === 'impostor') {
                await setDoc(roomRef, { ...roomData, status: 'results', winner: 'crewmate', eliminatedPlayerId });
            } else {
                const remainingPlayers = roomData.players.filter(p => p.id !== eliminatedPlayerId);
                const remainingImpostors = remainingPlayers.filter(p => p.role === 'impostor').length;

                if (remainingImpostors >= remainingPlayers.length - remainingImpostors) {
                    await setDoc(roomRef, { ...roomData, status: 'results', winner: 'impostor', eliminatedPlayerId });
                } else {
                    const resetPlayers = roomData.players.map(p => ({ ...p, vote: null }));
                    await setDoc(roomRef, { ...roomData, status: 'playing', players: resetPlayers });
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                showScreen('login');
            } else {
                signInAnonymously(auth).catch(error => console.error("Error signing in anonymously:", error));
            }
        });

    </script>
</body>
</html>
