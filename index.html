<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Futbolero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const firebaseConfig = {
            apiKey: "AIzaSyDOlq20cY--SAupjY3DG2yPRfjJ0u2KIC8",
            authDomain: "impostor-futbolero.firebaseapp.com",
            projectId: "impostor-futbolero",
            storageBucket: "impostor-futbolero.firebasestorage.app",
            messagingSenderId: "367880301498",
            appId: "1:367880301498:web:5bd06e02107893da5f8b83",
            measurementId: "G-QC9KW21MEL"
        };

        // --- Lista de Futbolistas (Top 100 y Venezolanos) ---
        const futbolistas = [
            "Pelé", "Diego Maradona", "Lionel Messi", "Cristiano Ronaldo", "Zinedine Zidane",
            "Johan Cruyff", "Franz Beckenbauer", "Ferenc Puskás", "Alfredo Di Stéfano", "Garrincha",
            "Michel Platini", "Lev Yashin", "Eusébio", "Ronaldo Nazário", "Marco van Basten",
            "Bobby Charlton", "George Best", "Gerd Müller", "Paolo Maldini", "Bebeto",
            "Romário", "Ronaldinho", "Kaká", "Thierry Henry", "Raúl González",
            "Andrés Iniesta", "Xavi Hernández", "Luka Modrić", "Sergio Ramos", "Iker Casillas",
            "Gianluigi Buffon", "Andrea Pirlo", "Alessandro Del Piero", "Francesco Totti", "Roberto Baggio",
            "Dennis Bergkamp", "Ruud Gullit", "Frank Rijkaard", "Edwin van der Sar", "Kylian Mbappé",
            "Erling Haaland", "Neymar Jr.", "Mohamed Salah", "Kevin De Bruyne", "Harry Kane",
            "Robert Lewandowski", "Karim Benzema", "Luis Suárez", "Arjen Robben", "Franck Ribéry",
            "Manuel Neuer", "Alisson Becker", "Thibaut Courtois", "Virgil van Dijk", "Sergio Agüero",
            "David Beckham", "Paul Scholes", "Ryan Giggs", "Steven Gerrard", "Frank Lampard",
            "Didier Drogba", "Samuel Eto'o", "Michael Essien", "Yaya Touré", "Daniele De Rossi",
            "N'Golo Kanté", "Patrick Vieira", "Claude Makélélé", "Thiago Silva", "Giorgio Chiellini",
            "Leonardo Bonucci", "José Mourinho", "Pep Guardiola", "Jürgen Klopp", "Carlo Ancelotti",
            "Arsène Wenger", "Sir Alex Ferguson", "Diego Simeone", "Marc Overmars", "Javier Zanetti",
            "Gabriel Batistuta", "Hernán Crespo", "Juan Román Riquelme", "Ariel Ortega", "Marcelo Salas",
            "Iván Zamorano", "Carlos Valderrama", "René Higuita", "Jorge Campos", "Hugo Sánchez",
            "Claudio Caniggia", "Enzo Francescoli", "Alexis Sánchez", "Arturo Vidal", "Keylor Navas",
            "Hirving Lozano", "Alphonso Davies", "Christian Pulisic", "Shinji Kagawa", "Heung-min Son",
            "Mohamed Aboutrika", "Wael Gomaa", "Hossam Hassan", "Essam El-Hadary", "Mido",
            "Javier Pastore", "Gonzalo Higuaín", "Ángel Di María", "Paulo Dybala", "Juan Sebastián Verón",
            // Jugadores venezolanos
            "Juan Arango", "Salomón Rondón", "Tomás Rincón", "Oswaldo Vizcarrondo", "José Manuel Rey",
            "Gabriel Cichero", "Yeferson Soteldo", "Josef Martínez", "Wuilker Fariñez", "Fernando Amorebieta"
        ];

        let db;
        let auth;
        let userId = null;
        let userName = null;
        let roomDocRef = null;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase inicializado con éxito.");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        const roomsCollectionName = 'rooms';

        const loadingScreen = document.getElementById('loadingScreen');
        const homeScreen = document.getElementById('homeScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const votingScreen = document.getElementById('votingScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const userNameInput = document.getElementById('userNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomInput = document.getElementById('joinRoomInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const lobbyPlayersList = document.getElementById('lobbyPlayersList');
        const startGameBtn = document.getElementById('startGameBtn');
        const roleCard = document.getElementById('roleCard');
        const votingPlayersList = document.getElementById('votingPlayersList');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const finalPlayersList = document.getElementById('finalPlayersList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const gamePlayersList = document.getElementById('gamePlayersList');
        const countdownTimer = document.getElementById('countdownTimer');

        let currentRoomId = null;
        let userRole = null;
        let hasVoted = false;
        let timerIntervalId = null;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            setTimeout(() => {
                messageModal.classList.add('hidden');
            }, 3000);
        }

        let authHandled = false;
        onAuthStateChanged(auth, async (user) => {
            if (authHandled) return;
            authHandled = true;

            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID de Usuario: ${userId}`;
                userName = localStorage.getItem('userName');
                if (userName) {
                    userNameInput.value = userName;
                }
                showScreen('homeScreen');
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error en la autenticación:", error);
                    showMessage("Error al iniciar sesión. Intenta recargar la página.");
                    showScreen('homeScreen');
                }
            }
        });

        function subscribeToRoomUpdates(roomCode) {
            roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', roomsCollectionName, roomCode);
            onSnapshot(roomDocRef, (doc) => {
                if (doc.exists()) {
                    const roomData = doc.data();
                    if (roomData.status === 'lobby') {
                        updateLobbyUI(roomData);
                    } else if (roomData.status === 'in_game') {
                        assignAndShowRole(roomData);
                    } else if (roomData.status === 'voting') {
                        showVotingScreen(roomData);
                        checkMajorityVote(roomData); // ✅ Ahora todos lo ejecutan
                    } else if (roomData.status === 'game_over') {
                        showGameOver(roomData);
                    }
                }
            });
        }

        function showVotingScreen(roomData) {
            showScreen('votingScreen');
            votingPlayersList.innerHTML = '';
            hasVoted = roomData.votes[userId] !== undefined;

            roomData.players.forEach(player => {
                if (!player.isEliminated) {
                    const voteCount = Object.values(roomData.votes || {}).filter(vote => vote === player.userId).length;
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${player.name} (${voteCount} votos)</span>
                        <button class="vote-btn" data-player-id="${player.userId}" ${hasVoted ? 'disabled' : ''}>Votar</button>
                    `;
                    votingPlayersList.appendChild(li);
                }
            });

            setTimeout(() => {
                document.querySelectorAll(".vote-btn").forEach(btn => {
                    btn.addEventListener("click", async (e) => {
                        if (hasVoted) return;
                        const votedPlayerId = e.target.getAttribute("data-player-id");
                        await vote(votedPlayerId);
                        showMessage("Tu voto ha sido registrado.");
                    });
                });
                document.getElementById("exitVotingBtn").addEventListener("click", () => {
                    showScreen("gameScreen");
                });
            }, 100);
        }

        async function vote(votedPlayerId) {
            await runTransaction(db, async (transaction) => {
                const roomDocForTxn = await transaction.get(roomDocRef);
                const roomData = roomDocForTxn.data();
                const votes = roomData.votes || {};
                votes[userId] = votedPlayerId;
                transaction.update(roomDocRef, { votes: votes });
            });
        }

        async function checkMajorityVote(roomData) {
            const votes = roomData.votes || {};
            const activePlayers = roomData.players.filter(p => !p.isEliminated);
            if (Object.keys(votes).length < activePlayers.length) return;

            const voteCounts = {};
            for (const voterId in votes) {
                const votedPlayerId = votes[voterId];
                voteCounts[votedPlayerId] = (voteCounts[votedPlayerId] || 0) + 1;
            }

            let maxVotes = 0;
            let eliminatedPlayerId = null;
            for (const playerId in voteCounts) {
                if (voteCounts[playerId] > maxVotes) {
                    maxVotes = voteCounts[playerId];
                    eliminatedPlayerId = playerId;
                }
            }

            const playersWithMaxVotes = Object.keys(voteCounts).filter(id => voteCounts[id] === maxVotes);
            if (playersWithMaxVotes.length > 1) {
                await setDoc(roomDocRef, { status: 'in_game', votes: {} }, { merge: true });
                showMessage("Hubo un empate en la votación. Nadie fue eliminado.");
                return;
            }

            if (eliminatedPlayerId && maxVotes > 0) {
                await eliminateAndCheckWin(eliminatedPlayerId, roomData.players);
            }
        }

        async function eliminateAndCheckWin(eliminatedPlayerId, currentPlayers) {
            await runTransaction(db, async (transaction) => {
                const roomDocForTxn = await transaction.get(roomDocRef);
                const roomData = roomDocForTxn.data();
                const players = roomData.players;

                const updatedPlayers = players.map(p => {
                    if (p.userId === eliminatedPlayerId) {
                        return { ...p, isEliminated: true };
                    }
                    return p;
                });

                const remainingPlayers = updatedPlayers.filter(p => !p.isEliminated);
                const remainingImpostors = remainingPlayers.filter(p => p.role === 'Impostor');
                const remainingFutboleros = remainingPlayers.filter(p => p.role === 'Futbolero');

                let winner = null;
                if (remainingImpostors.length === 0) {
                    winner = 'Futboleros';
                } else if (remainingImpostors.length >= remainingFutboleros.length) {
                    winner = 'Impostor';
                }

                if (winner) {
                    transaction.update(roomDocRef, {
                        status: 'game_over',
                        winner: winner,
                        eliminatedPlayer: updatedPlayers.find(p => p.userId === eliminatedPlayerId).name,
                        players: updatedPlayers
                    });
                } else {
                    transaction.update(roomDocRef, {
                        status: 'in_game',
                        votes: {},
                        players: updatedPlayers,
                        futbolista: futbolistas[Math.floor(Math.random() * futbolistas.length)]
                    });
                }
            });
        }

        function showGameOver(roomData) {
            if (roomData.winner === 'Impostor') {
                gameOverMessage.textContent = '¡El Impostor ha ganado!';
                gameOverMessage.classList.add('text-red-500');
            } else {
                gameOverMessage.textContent = '¡Los Futboleros han ganado!';
                gameOverMessage.classList.add('text-green-500');
            }

            finalPlayersList.innerHTML = '';
            roomData.players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name} - ${p.role}`;
                finalPlayersList.appendChild(li);
            });
            showScreen('gameOverScreen');
        }
    </script>
</head>
<body>
    <div id="loadingScreen" class="screen">Cargando...</div>

    <div id="homeScreen" class="screen hidden">
        <input type="text" id="userNameInput">
        <button id="createRoomBtn">Crear Sala</button>
        <input type="text" id="joinRoomInput">
        <button id="joinRoomBtn">Unirse</button>
    </div>

    <div id="lobbyScreen" class="screen hidden">
        <span id="roomCodeDisplay"></span>
        <ul id="lobbyPlayersList"></ul>
        <button id="startGameBtn">Empezar Juego</button>
    </div>

    <div id="gameScreen" class="screen hidden">
        <div id="roleCard"></div>
        <ul id="gamePlayersList"></ul>
        <button id="callVoteBtn">Llamar a votación</button>
    </div>

    <div id="votingScreen" class="screen hidden">
        <ul id="votingPlayersList"></ul>
        <button id="exitVotingBtn">Salir de la votación</button>
    </div>

    <div id="gameOverScreen" class="screen hidden">
        <h2 id="gameOverMessage"></h2>
        <ul id="finalPlayersList"></ul>
        <p id="countdownTimer"></p>
    </div>

    <div id="messageModal" class="hidden"><p id="messageText"></p></div>
    <div id="userIdDisplay"></div>
</body>
</html>
